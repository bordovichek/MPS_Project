{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MPS Project - Карта</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link rel="icon" href="https://placehold.co/32x32/007bff/ffffff?text=%E2%9C%88%EF%B8%8F" type="image/x-icon">

    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        :root {
            --bg-gradient-start: #89f7fe;
            --bg-gradient-end: #66a6ff;
            --text-color: #333;
            --heading-color: #1f4e79;
            --container-bg: rgba(255, 255, 255, 0.92);
            --container-shadow-1: rgba(0, 0, 0, 0.2);
            --container-shadow-2: rgba(0, 0, 0, 0.1);
            --airplane-bg: #fefefe;
            --airplane-shadow: rgba(0, 0, 0, 0.08);
            --input-border: #a7d9ff;
            --input-bg: #f8faff;
            --input-focus-border: #1E90FF;
            --input-focus-shadow: rgba(30, 144, 255, 0.3);
            --button-bg: #1E90FF;
            --button-hover-bg: #1C7ED6;
            --button-active-bg: #1A75C4;
            --button-shadow: rgba(0, 87, 184, 0.3);
            --button-hover-shadow: rgba(0, 87, 184, 0.4);
            --ripple-color: rgba(255, 255, 255, 0.7);
            --light-effect-color-1: rgba(255, 255, 255, 0.4);
            --light-effect-color-2: rgba(255, 255, 255, 0.3);
        }

        body.dark-theme {
            --bg-gradient-start: #2c3e50;
            --bg-gradient-end: #34495e;
            --text-color: #e0e0e0;
            --heading-color: #f0f0f0;
            --container-bg: rgba(44, 62, 80, 0.92);
            --container-shadow-1: rgba(0, 0, 0, 0.5);
            --container-shadow-2: rgba(0, 0, 0, 0.3);
            --airplane-bg: #3b5066;
            --airplane-shadow: rgba(0, 0, 0, 0.3);
            --input-border: #5a7d9a;
            --input-bg: #4a627a;
            --input-focus-border: #6fa8dc;
            --input-focus-shadow: rgba(111, 168, 220, 0.3);
            --button-bg: #4a779a;
            --button-hover-bg: #5a8aa9;
            --button-active-bg: #3a6280;
            --button-shadow: rgba(0, 0, 0, 0.4);
            --button-hover-shadow: rgba(0, 0, 0, 0.5);
            --ripple-color: rgba(0, 0, 0, 0.3);
            --light-effect-color-1: rgba(255, 255, 255, 0.1);
            --light-effect-color-2: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding-top: 20px;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-color);
            text-align: center;
            overflow-x: hidden;
            position: relative;
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
            transition: background 0.5s ease, color 0.5s ease;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .light-effect {
            position: absolute;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, var(--light-effect-color-1) 0%, rgba(255, 255, 255, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            transition: background 0.5s ease;
        }

        .light-effect:nth-child(1) {
            top: -50px;
            left: -50px;
            animation: lightMove 20s linear infinite alternate;
        }

        .light-effect:nth-child(2) {
            top: auto;
            bottom: -50px;
            left: auto;
            right: -50px;
            width: 180px;
            height: 180px;
            animation: lightMove 25s linear infinite alternate-reverse;
        }

        .light-effect:nth-child(3) {
            top: 20%;
            left: 80%;
            width: 150px;
            height: 150px;
            animation: lightMove 18s ease-in-out infinite alternate-reverse;
            animation-delay: 2s;
        }

        .light-effect:nth-child(4) {
            bottom: 10%;
            left: 10%;
            width: 220px;
            height: 220px;
            background: radial-gradient(circle, var(--light-effect-color-2) 0%, rgba(255, 255, 255, 0) 70%);
            animation: lightMove 22s linear infinite alternate;
            animation-delay: 4s;
        }

        @keyframes lightMove {
            0% { transform: translate(0, 0) scale(1); opacity: 0.5; }
            25% { transform: translate(calc(100vw - 100px), calc(100vh - 100px)) scale(1.1); opacity: 0.6; }
            50% { transform: translate(calc(100vw / 2), 0) scale(0.9); opacity: 0.4; }
            75% { transform: translate(0, calc(100vh - 100px)) scale(1.2); opacity: 0.7; }
            100% { transform: translate(0, 0) scale(1); opacity: 0.5; }
        }

        .main-content-container {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 15px 40px var(--container-shadow-1), 0 5px 10px var(--container-shadow-2);
            transition: box-shadow 0.3s ease, background-color 0.5s ease;
            animation: fadeIn 1s ease-out;
            position: relative;
            z-index: 1;
            margin-bottom: 20px;
            width: calc(100% - 60px);
            max-width: none;
            box-sizing: border-box;
        }

        .main-content-container:hover {
            box-shadow: 0 20px 50px var(--container-shadow-1), 0 8px 15px var(--container-shadow-2);
        }

        h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5em;
            color: var(--heading-color);
            margin-bottom: 10px;
            animation: slideInDown 0.8s ease-out;
            transition: color 0.5s ease;
        }

        .slogan {
            font-family: 'Inter', sans-serif;
            font-size: 1.1em;
            color: var(--text-color);
            margin-bottom: 25px;
            animation: fadeIn 1s ease-out 0.3s backwards;
            transition: color 0.5s ease;
        }

        .form-area {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 15px;
            margin-top: 15px;
        }

        .select-group {
            flex: 1 1 calc(50% - 7.5px);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 0;
            position: relative; /* Для позиционирования кнопки удаления */
        }

        .select-group:last-of-type {
            flex: 1 1 100%;
        }

        .select-group label {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: var(--heading-color);
            font-size: 1em;
            transition: color 0.5s ease;
        }

        .select-group select,
        .select-group input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95em;
            color: var(--text-color);
            background-color: var(--input-bg);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.5s ease, color 0.5s ease;
        }

        .select-group select:focus,
        .select-group input[type="text"]:focus {
            outline: none;
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 4px var(--input-focus-shadow), inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .add-airport-btn,
        .build-route-btn {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 12px 25px;
            text-align: center;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px var(--button-shadow);
            clip-path: polygon(15px 0, calc(100% - 15px) 0, 100% 15px, 100% calc(100% - 15px), calc(100% - 15px) 100%, 15px 100%, 0 calc(100% - 15px), 0 15px);
            position: relative;
            overflow: hidden;
            z-index: 1;
            margin-top: 10px;
        }

        .add-airport-btn:hover,
        .build-route-btn:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-3px) scale(1.02) perspective(1000px) rotateX(2deg);
            box-shadow: 0 7px 18px var(--button-hover-shadow);
        }

        .add-airport-btn:active,
        .build-route-btn:active {
            transform: translateY(-1px) scale(1.005);
            background-color: var(--button-active-bg);
        }

        .build-route-btn:disabled {
            background-color: var(--input-border); /* Используем цвет рамки для отключенной кнопки */
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .add-airport-btn i,
        .build-route-btn i {
            margin-right: 6px;
            font-size: 0.9em;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: var(--ripple-color);
            transform: scale(0);
            animation: ripple 0.6s linear;
            z-index: 0;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        #map {
            height: 500px;
            width: calc(100% - 60px);
            max-width: none;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            margin-top: 20px;
            z-index: 1;
        }

        #routeDetails {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 20px var(--container-shadow-2);
            margin-top: 20px;
            width: calc(100% - 60px);
            max-width: none;
            text-align: left;
            box-sizing: border-box;
            transition: opacity 0.5s ease, transform 0.5s ease, background-color 0.5s ease;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }
        #routeDetails.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        #routeDetails h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6em;
            color: var(--heading-color);
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
            transition: color 0.5s ease;
        }

        #routeDetails p {
            font-family: 'Inter', sans-serif;
            font-size: 1em;
            line-height: 1.5;
            color: var(--text-color);
            margin-bottom: 6px;
            transition: color 0.5s ease;
        }

        #routeDetails strong {
            color: var(--button-bg);
            transition: color 0.5s ease;
        }

        #retiredAircraftNotice {
            margin-top: 10px;
            padding: 12px;
            border-radius: 8px;
            background-color: var(--input-bg); /* Используем цвет фона ввода для уведомления */
            border-left: 5px solid #ffc107;
            color: var(--text-color); /* Используем основной цвет текста */
            font-family: 'Inter', sans-serif;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: opacity 0.5s ease, transform 0.5s ease, background-color 0.5s ease, color 0.5s ease;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }
        #retiredAircraftNotice.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        #errorMessage {
            background-color: var(--container-bg); /* Используем цвет фона контейнера */
            border-left: 5px solid #dc3545;
            color: #dc3545; /* Красный цвет для текста ошибки */
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: left;
            font-family: 'Inter', sans-serif;
            font-size: 0.95em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            box-sizing: border-box;
            transition: opacity 0.5s ease, transform 0.5s ease, background-color 0.5s ease, color 0.5s ease;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }
        #errorMessage.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes slideInDown {
            from { transform: translateY(-60px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeInUp {
            from { transform: translateY(60px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .theme-toggle-btn {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px var(--button-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .theme-toggle-btn:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 7px 18px var(--button-hover-shadow);
        }

        .theme-toggle-btn:active {
            transform: translateY(0);
            background-color: var(--button-active-bg);
        }

        .home-btn {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px var(--button-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
        }

        .home-btn:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 7px 18px var(--button-hover-shadow);
        }

        .home-btn:active {
            transform: translateY(0);
            background-color: var(--button-active-bg);
        }

        .remove-airport-btn {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #ef4444;
            color: #fff;
            border-radius: 9999px;
            height: 1.5rem;
            width: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transform: translate(50%, -50%);
            z-index: 10;
        }
        .remove-airport-btn:hover {
            background-color: #dc2626;
        }

        .numbered-marker-icon {
            position: relative;
            text-align: center;
            white-space: nowrap;
        }

        .numbered-marker-icon .marker-number {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background-color: blue;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            line-height: 18px;
            font-size: 10px;
            font-weight: bold;
            z-index: 2;
        }

        .numbered-marker-icon .marker-iata-code {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            font-weight: bold;
            color: black;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 1px 3px;
            border-radius: 2px;
            z-index: 1;
        }

        .intermediate-marker-icon {
            position: relative;
            text-align: center;
            white-space: nowrap;
            background-color: blue;
            border-radius: 50%;
            width: 10px;
            height: 10px;
            border: 1px solid white;
            box-sizing: border-box;
        }

        .intermediate-marker-icon .marker-iata-code {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            font-weight: bold;
            color: black;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 1px 3px;
            border-radius: 2px;
            line-height: normal;
        }

        @media (max-width: 768px) {
            .main-content-container, #map, #routeDetails, #errorMessage {
                width: calc(100% - 30px);
                padding: 15px;
            }
            h2 {
                font-size: 2.2em;
            }
            .slogan {
                font-size: 1.1em;
            }
            .select-group {
                flex: 1 1 100%;
            }
            .add-airport-btn, .build-route-btn {
                padding: 10px 20px;
                font-size: 0.95em;
            }
            #map {
                height: 350px;
            }
            .theme-toggle-btn, .home-btn {
                top: 10px;
                padding: 8px 12px;
                font-size: 1em;
            }
            .home-btn {
                left: 10px;
            }
        }

        @media (max-width: 480px) {
            h2 {
                font-size: 1.6em;
            }
            .slogan {
                font-size: 0.9em;
            }
            .select-group label {
                font-size: 0.9em;
            }
            .select-group select,
            .select-group input[type="text"] {
                padding: 6px 10px;
                font-size: 0.85em;
            }
            .add-airport-btn, .build-route-btn {
                padding: 8px 15px;
                font-size: 0.85em;
            }
            #map {
                height: 250px;
            }
            #routeDetails, #errorMessage {
                padding: 10px;
                font-size: 0.85em;
            }
            .theme-toggle-btn, .home-btn {
                top: 5px;
                padding: 6px 10px;
                font-size: 0.9em;
            }
            .home-btn {
                left: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="light-effect"></div>
    <div class="light-effect"></div>
    <div class="light-effect"></div>
    <div class="light-effect"></div>

    <div class="main-content-container">
        <button id="homeBtn" class="home-btn">
            <i class="fas fa-home"></i>
        </button>
        <button id="themeToggleBtn" class="theme-toggle-btn">
            <i class="fas fa-moon"></i>
        </button>

        <h2 class="text-2xl font-bold mb-4 text-center">MPS Project</h2>
        <p class="slogan">Постройте оптимальный маршрут для вашего самолета</p>

        <div class="form-area" id="airportSelectionArea">
            <div class="select-group">
                <label for="airport1" class="font-medium text-gray-700">Выберите аэропорт 1:</label>
                <select id="airport1">
                    <option value="">--</option>
                </select>
                <input type="text" id="searchAirport1" placeholder="Поиск Аэропорта 1 (имя/IATA/страна)">
            </div>

            <div class="select-group">
                <label for="airport2" class="font-medium text-gray-700">Выберите аэропорт 2:</label>
                <select id="airport2" disabled>
                    <option value="">--</option>
                </select>
                <input type="text" id="searchAirport2" placeholder="Поиск Аэропорта 2 (имя/IATA/страна)">
            </div>

            <button type="button" id="addAirportBtn" class="add-airport-btn">+</button>

            <div class="select-group">
                <label for="aircraft" class="font-medium text-gray-700">Выберите самолет:</label>
               <select id="aircraft">
                    <option value="">--</option>
                </select>
                <div id="retiredAircraftNotice" class="hidden mt-6 bg-yellow-200 border-l-4 border-yellow-600 text-yellow-800 p-4 rounded shadow">
                    <strong>Внимание:</strong> самолёт <strong id="retiredAircraftName"></strong> выведен из эксплуатации и включён в список исключительно для демонстрации своих характеристик.
                </div>
            </div>
            <button type="button" id="buildRouteBtn" class="build-route-btn" disabled>Построить маршрут</button>
        </div>

        <div id="map"></div>

        <div id="routeDetails" class="hidden">
            <h3>Информация о маршруте:</h3>
            <p>Самолет: <strong id="detailPlaneName"></strong></p>
            <p>Общая дистанция: <strong id="detailWholeDistance"></strong> км</p>
            <p>Количество перелетов: <strong id="detailFlights"></strong></p>
            <p>Максимальное расстояние одного перелета: <strong id="detailMaxSegmentDistance"></strong> км</p>
            <p>Примерное время в пути: <strong id="detailTime"></strong> часов</p>
            <p>Примерная стоимость топлива: <strong id="detailCost"></strong> $</p>
        </div>
        <div id="errorMessage" class="error-message hidden"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const aircraftSelectNotice = document.getElementById("aircraft");
        const retiredNotice = document.getElementById("retiredAircraftNotice");
        const retiredNameSpan = document.getElementById("retiredAircraftName");

        if (aircraftSelectNotice) {
            aircraftSelectNotice.addEventListener("change", function() {
                const selectedOption = aircraftSelectNotice.options[aircraftSelectNotice.selectedIndex];
                const inService = selectedOption.getAttribute("data-in-service");
                const aircraftName = selectedOption.textContent.trim();

                if (inService === "false") {
                    retiredNameSpan.textContent = aircraftName;
                    retiredNotice.classList.remove("hidden");
                } else {
                    retiredNotice.classList.add("hidden");
                }
            });
        }

        const map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const airportSelectionArea = document.getElementById('airportSelectionArea');
        const addAirportBtn = document.getElementById('addAirportBtn');
        const buildRouteBtn = document.getElementById('buildRouteBtn');
        const aircraftSelect = document.getElementById('aircraft');
        const routeDetailsDiv = document.getElementById('routeDetails');
        const errorMessageDiv = document.getElementById('errorMessage');

        let routePolylineLayerGroup = L.layerGroup().addTo(map);
        let routeMarkerLayerGroup = L.layerGroup().addTo(map);

        let airportSelectors = [];
        let airportSearchInputs = [];
        let originalAirportOptions = [];

        const airport1Select = document.getElementById('airport1');
        const airport2Select = document.getElementById('airport2');
        const searchAirport1Input = document.getElementById('searchAirport1');
        const searchAirport2Input = document.getElementById('searchAirport2');

        airportSelectors.push(airport1Select);
        airportSelectors.push(airport2Select);
        airportSearchInputs.push(searchAirport1Input);
        airportSearchInputs.push(searchAirport2Input);

        let allAirportsData = [];
        let airportsByCode = {};
        let allAirplanesData = [];

        async function loadInitialData() {
            try {
                const response = await fetch('/api/initial_data/');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();

                allAirportsData = data.airports;
                allAirplanesData = data.airplanes;

                allAirportsData.forEach(airport => {
                    airportsByCode[airport.iata_code] = airport;
                });

                originalAirportOptions = allAirportsData.map(airport => {
                    const option = document.createElement('option');
                    option.value = airport.iata_code;
                    option.textContent = `${airport.name} (${airport.iata_code}) - ${airport.country}`;
                    option.dataset.lat = airport.latitude;
                    option.dataset.lon = airport.longitude;
                    option.dataset.name = airport.name;
                    option.dataset.country = airport.country;
                    return option;
                });

                airportSelectors.forEach(select => {
                    select.innerHTML = '';
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "--";
                    select.appendChild(defaultOption);
                    originalAirportOptions.forEach(opt => select.appendChild(opt.cloneNode(true)));
                });

                aircraftSelect.innerHTML = '';
                const noPlaneOption = document.createElement('option');
                noPlaneOption.value = "";
                noPlaneOption.textContent = "Без выбора самолета";
                aircraftSelect.appendChild(noPlaneOption);

                allAirplanesData.forEach(plane => {
                    const option = document.createElement('option');
                    option.value = plane.id;
                    option.textContent = plane.name;
                    option.setAttribute('data-in-service', plane.in_service ? 'true' : 'false');
                    aircraftSelect.appendChild(option);
                });

                airport1Select.disabled = false;
                searchAirport1Input.disabled = false;
                updateMapAndSelections();

            } catch (error) {
                console.error("Ошибка загрузки initial data:", error);
                showErrorMessage(`Ошибка загрузки данных аэропортов/самолетов: ${error.message}`);
            }
        }

        function hideRouteDetailsAndErrors() {
            routeDetailsDiv.classList.add('hidden');
            errorMessageDiv.classList.add('hidden');
            errorMessageDiv.textContent = '';
        }

        function showErrorMessage(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            routeDetailsDiv.classList.add('hidden');
        }

        function filterAirportOptions(selectElement, searchInput) {
            const searchText = searchInput.value.toLowerCase();
            const currentValue = selectElement.value;
            selectElement.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "--";
            selectElement.appendChild(defaultOption);

            let foundCurrentValue = false;

            originalAirportOptions.forEach(option => {
                const airportName = option.dataset.name ? option.dataset.name.toLowerCase() : '';
                const iataCode = option.value.toLowerCase();
                const country = option.dataset.country ? option.dataset.country.toLowerCase() : '';

                if (airportName.includes(searchText) || iataCode.includes(searchText) || country.includes(searchText)) {
                    const clonedOption = option.cloneNode(true);
                    if (clonedOption.value === currentValue) {
                        clonedOption.selected = true;
                        foundCurrentValue = true;
                    }
                    selectElement.appendChild(clonedOption);
                }
            });

            if (!foundCurrentValue && currentValue !== "") {
                selectElement.value = "";
            }
        }

        function updateMapAndSelections() {
            routePolylineLayerGroup.clearLayers();
            routeMarkerLayerGroup.clearLayers();
            hideRouteDetailsAndErrors();

            let selectedAirports = [];
            let validSelectionsCount = 0;

            airportSelectors.forEach((select, index) => {
                const option = select.selectedOptions[0];
                if (option && option.value) {
                    const airportData = airportsByCode[option.value];
                    if (airportData) {
                        selectedAirports.push({
                            lat: airportData.latitude,
                            lon: airportData.longitude,
                            name: airportData.name,
                            iata: airportData.iata_code,
                            number: index + 1
                        });
                        validSelectionsCount++;
                    }
                }
            });

            for (let i = 0; i < airportSelectors.length; i++) {
                const currentSelect = airportSelectors[i];
                const currentSearch = airportSearchInputs[i];
                const currentGroup = currentSelect.closest('.select-group');
                const removeBtn = currentGroup ? currentGroup.querySelector('.remove-airport-btn') : null;

                if (i === 0) {
                    currentSelect.disabled = false;
                    currentSearch.disabled = false;
                    if (removeBtn) removeBtn.classList.add('hidden');
                } else {
                    const prevSelect = airportSelectors[i - 1];
                    if (prevSelect && prevSelect.value) {
                        currentSelect.disabled = false;
                        currentSearch.disabled = false;
                        if (removeBtn) removeBtn.classList.remove('hidden');
                    } else {
                        currentSelect.disabled = true;
                        currentSelect.value = "";
                        currentSearch.disabled = true;
                        currentSearch.value = "";
                        filterAirportOptions(currentSelect, currentSearch);
                        if (removeBtn) removeBtn.classList.add('hidden');
                    }
                }
            }

            const lastActiveAirportSelect = airportSelectors.findLast(select => !select.disabled);
            const maxAirports = 6;
            if (lastActiveAirportSelect && lastActiveAirportSelect.value && airportSelectors.length < maxAirports) {
                addAirportBtn.disabled = false;
            } else {
                addAirportBtn.disabled = true;
            }

            if (validSelectionsCount >= 2) {
                buildRouteBtn.disabled = false;
            } else {
                buildRouteBtn.disabled = true;
            }

            if (selectedAirports.length > 0) {
                let allLatsLons = [];
                selectedAirports.forEach(airport => {
                    const iataHtml = `<div class="marker-iata-code">${airport.iata}</div>`;
                    const numberIcon = L.divIcon({
                        className: 'numbered-marker-icon',
                        html: `<div class="marker-number">${airport.number}</div>${iataHtml}`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    });

                    const m = L.marker([airport.lat, airport.lon], { icon: numberIcon }).addTo(routeMarkerLayerGroup)
                        .bindPopup(`<b>${airport.name}</b> (${airport.iata})`);
                    allLatsLons.push([airport.lat, airport.lon]);
                });

                if (allLatsLons.length > 0) {
                    const bounds = L.latLngBounds(allLatsLons);
                    map.fitBounds(bounds.pad(0.5));
                }
            }
        }

        function initializeNewAirportSelector(index) {
            const selectGroup = document.createElement('div');
            selectGroup.className = 'select-group';
            selectGroup.id = `airportGroup${index}`;

            const label = document.createElement('label');
            label.htmlFor = `airport${index}`;
            label.textContent = `Выберите аэропорт ${index}:`;
            label.className = 'font-medium text-gray-700';
            selectGroup.appendChild(label);

            const selectElement = document.createElement('select');
            selectElement.id = `airport${index}`;
            selectElement.name = `airport${index}`;
            selectElement.disabled = true;
            airportSelectors.push(selectElement);

            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "--";
            selectElement.appendChild(defaultOption);

            originalAirportOptions.forEach(opt => {
                selectElement.appendChild(opt.cloneNode(true));
            });

            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.id = `searchAirport${index}`;
            searchInput.placeholder = `Поиск Аэропорта ${index} (имя/IATA/страна)`;
            searchInput.disabled = true;
            airportSearchInputs.push(searchInput);

            selectGroup.appendChild(selectElement);
            selectGroup.appendChild(searchInput);

            if (index > 2) {
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-airport-btn';
                removeBtn.textContent = 'x';
                removeBtn.addEventListener('click', () => {
                    removeAirportSelector(index);
                });
                selectGroup.appendChild(removeBtn);
            }

            const addAirportBtnElement = document.getElementById('addAirportBtn');
            airportSelectionArea.insertBefore(selectGroup, addAirportBtnElement);

            selectElement.addEventListener('change', updateMapAndSelections);
            searchInput.addEventListener('input', () => {
                filterAirportOptions(selectElement, searchInput);
            });

            setTimeout(() => {
                airportSelectionArea.scrollTop = airportSelectionArea.scrollHeight;
            }, 0);
        }

        function removeAirportSelector(indexToRemove) {
            if (indexToRemove <= 2) {
                console.warn("Невозможно удалить первые два аэропорта.");
                return;
            }

            const groupToRemove = document.getElementById(`airportGroup${indexToRemove}`);
            if (groupToRemove) {
                groupToRemove.remove();

                airportSelectors.splice(indexToRemove - 1, 1);
                airportSearchInputs.splice(indexToRemove - 1, 1);

                for (let i = indexToRemove - 1; i < airportSelectors.length; i++) {
                    const currentGroup = airportSelectors[i].closest('.select-group');
                    const newIndex = i + 1;

                    currentGroup.id = `airportGroup${newIndex}`;
                    currentGroup.querySelector('label').htmlFor = `airport${newIndex}`;
                    currentGroup.querySelector('label').textContent = `Выберите аэропорт ${newIndex}:`;
                    airportSelectors[i].id = `airport${newIndex}`;
                    airportSelectors[i].name = `airport${newIndex}`;
                    airportSearchInputs[i].id = `searchAirport${newIndex}`;
                    airportSearchInputs[i].placeholder = `Поиск Аэропорта ${newIndex} (имя/IATA/страна)`;

                    const removeBtn = currentGroup.querySelector('.remove-airport-btn');
                    if (removeBtn) {
                        const oldRemoveHandler = removeBtn._currentClickHandler;
                        if (oldRemoveHandler) {
                            removeBtn.removeEventListener('click', oldRemoveHandler);
                        }
                        const newRemoveHandler = () => removeAirportSelector(newIndex);
                        removeBtn.addEventListener('click', newRemoveHandler);
                        removeBtn._currentClickHandler = newRemoveHandler;
                    }
                }
            }
            updateMapAndSelections();
        }

        async function buildRoute() {
            routePolylineLayerGroup.clearLayers();
            routeMarkerLayerGroup.clearLayers();
            hideRouteDetailsAndErrors();

            let selectedAirportIATAs = [];
            airportSelectors.forEach(select => {
                const option = select.selectedOptions[0];
                if (option && option.value) {
                    selectedAirportIATAs.push(option.value);
                }
            });

            selectedAirportIATAs = [...new Set(selectedAirportIATAs.filter(iata => iata !== ''))];

            if (selectedAirportIATAs.length < 2) {
                showErrorMessage("Пожалуйста, выберите как минимум два уникальных аэропорта для построения маршрута.");
                return;
            }

            const selectedAircraftId = aircraftSelect.selectedOptions[0] && aircraftSelect.selectedOptions[0].value !== "" ? parseInt(aircraftSelect.selectedOptions[0].value, 10) : null;

            try {
                const csrfToken = getCookie('csrftoken');

                const response = await fetch('/api/calculate_route/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        airport_iatas: selectedAirportIATAs,
                        airplane_id: selectedAircraftId
                    }),
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || `HTTP error! Status: ${response.status}`);
                }

                routeMarkerLayerGroup.clearLayers();

                data.route_segments.forEach(segmentResult => {
                    if (segmentResult.routes && Array.isArray(segmentResult.routes)) {
                        segmentResult.routes.forEach(route => {
                            const pathCoordinates = route.inbetween;

                            if (pathCoordinates && pathCoordinates.length > 1) {
                                let currentSegmentPoints = [];
                                for (let i = 0; i < pathCoordinates.length - 1; i++) {
                                    const p1 = pathCoordinates[i];
                                    const p2 = pathCoordinates[i + 1];

                                    const lonDiff = Math.abs(p1[1] - p2[1]);

                                    const crossesMeridian = (lonDiff > 180) ||
                                                            (Math.sign(p1[1]) !== Math.sign(p2[1]) && Math.abs(p1[1]) + Math.abs(p2[1]) > 180);

                                    if (crossesMeridian) {
                                        if (currentSegmentPoints.length > 1) {
                                            L.polyline(currentSegmentPoints, { color: 'blue', weight: 3, opacity: 0.7 }).addTo(routePolylineLayerGroup);
                                        }

                                        L.circleMarker(p1, {
                                            radius: 6,
                                            color: 'blue',
                                            fillColor: 'blue',
                                            fillOpacity: 1,
                                            weight: 1
                                        }).addTo(routePolylineLayerGroup).bindTooltip(`Отлетаем через меридиан от ${p1[0].toFixed(2)}, ${p1[1].toFixed(2)}`);

                                        L.circleMarker(p2, {
                                            radius: 6,
                                            color: 'blue',
                                            fillColor: 'white',
                                            fillOpacity: 1,
                                            weight: 2
                                        }).addTo(routePolylineLayerGroup).bindTooltip(`Прибываем через меридиан в ${p2[0].toFixed(2)}, ${p2[1].toFixed(2)}`);

                                        currentSegmentPoints = [p2];
                                    } else {
                                        currentSegmentPoints.push(p1);
                                    }
                                }
                                currentSegmentPoints.push(pathCoordinates[pathCoordinates.length - 1]);
                                if (currentSegmentPoints.length > 1) {
                                    L.polyline(currentSegmentPoints, { color: 'blue', weight: 3, opacity: 0.7 }).addTo(routePolylineLayerGroup);
                                }
                            }
                        });
                    }
                });

                if (data.plane_cant) {
                    showErrorMessage("Самолет не смог совершить перелет без промежуточных дозаправок. Маршрут включает дополнительные остановки или некоторые сегменты были построены как прямые.");
                }

                const routeAirports = data.all_path_airports_iatas;

                const selectedAirportIATAsForMarkers = [];
                airportSelectors.forEach(select => {
                    const option = select.selectedOptions[0];
                    if (option && option.value) {
                        selectedAirportIATAsForMarkers.push(option.value);
                    }
                });

                routeAirports.forEach(iata => {
                    const airportData = airportsByCode[iata];
                    if (airportData) {
                        const isSelectedStartOrEnd = selectedAirportIATAsForMarkers.includes(iata);
                        let markerIcon;

                        const iataHtml = `<div class="marker-iata-code">${iata}</div>`;

                        if (isSelectedStartOrEnd) {
                            const index = selectedAirportIATAsForMarkers.indexOf(iata);
                            markerIcon = L.divIcon({
                                className: 'numbered-marker-icon',
                                html: `<div class="marker-number">${index + 1}</div>${iataHtml}`,
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            });
                        } else {
                            markerIcon = L.divIcon({
                                className: 'intermediate-marker-icon',
                                html: iataHtml,
                                iconSize: [25, 25],
                                iconAnchor: [12, 25]
                            });
                        }

                        const m = L.marker([airportData.latitude, airportData.longitude], { icon: markerIcon }).addTo(routeMarkerLayerGroup);
                        m.bindPopup(`<b>${airportData.name}</b> (${airportData.iata_code})`);
                    } else {
                        console.error(`Ошибка: Аэропорт с IATA-кодом ${iata} не найден в allAirportsData.`);
                    }
                });

                document.getElementById('detailPlaneName').textContent = data.plane || 'Не выбран';
                document.getElementById('detailWholeDistance').textContent = data.whole_distance.toFixed(2);
                document.getElementById('detailFlights').textContent = data.flights;
                document.getElementById('detailMaxSegmentDistance').textContent = data.max_distance.toFixed(2);
                document.getElementById('detailTime').textContent = data.time.toFixed(2);
                document.getElementById('detailCost').textContent = data.cost.toFixed(2);
                routeDetailsDiv.classList.remove('hidden');

                const layersInGroup = routePolylineLayerGroup.getLayers();

                if (layersInGroup.length > 0) {
                    let allCoords = [];
                    layersInGroup.forEach(layer => {
                        if (layer && typeof layer.getLatLngs === 'function') {
                            const latlngs = layer.getLatLngs();
                            if (Array.isArray(latlngs[0]) && Array.isArray(latlngs[0][0])) {
                                latlngs.forEach(part => allCoords.push(...part));
                            } else {
                                allCoords.push(...latlngs);
                            }
                        }
                    });

                    if (allCoords.length > 0) {
                        let bounds = L.latLngBounds(allCoords);
                        if (bounds.isValid()) {
                            try {
                                map.fitBounds(bounds.pad(0.1));
                            } catch (e) {
                                console.error("Ошибка при вызове map.fitBounds(bounds.pad(0.1)):", e);
                                showErrorMessage("Ошибка при центрировании карты по маршруту.");
                            }
                        } else {
                            showErrorMessage("Не удалось центрировать карту по маршруту (невалидные координаты).");
                        }
                    } else {
                        showErrorMessage("Не удалось центрировать карту по маршруту (нет координат).");
                    }
                }
            } catch (error) {
                console.error("Ошибка построения маршрута:", error);
                showErrorMessage(`Ошибка построения маршрута: ${error.message}`);
            }
        }

        function createRipple(event) {
            const button = event.currentTarget;
            const circle = document.createElement('span');
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;

            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - button.offsetLeft - radius}px`;
            circle.style.top = `${event.clientY - button.offsetTop - radius}px`;
            circle.classList.add('ripple');

            const oldRipple = button.querySelector('.ripple');
            if (oldRipple) {
                oldRipple.remove();
            }

            button.appendChild(circle);

            circle.addEventListener('animationend', () => {
                circle.remove();
            });
        }

        document.addEventListener("DOMContentLoaded", async function() {
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const homeBtn = document.getElementById('homeBtn');
            const body = document.body;
            const themeIcon = themeToggleBtn.querySelector('i');

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                body.classList.add('dark-theme');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                body.classList.remove('dark-theme');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }

            themeToggleBtn.addEventListener('click', (event) => {
                body.classList.toggle('dark-theme');
                if (body.classList.contains('dark-theme')) {
                    themeIcon.classList.remove('fa-moon');
                    themeIcon.classList.add('fa-sun');
                    localStorage.setItem('theme', 'dark');
                } else {
                    themeIcon.classList.remove('fa-sun');
                    themeIcon.classList.add('fa-moon');
                    localStorage.setItem('theme', 'light');
                }
                createRipple(event);
            });

            homeBtn.addEventListener('click', (event) => {
                createRipple(event);
                window.location.href = '/';
            });

            addAirportBtn.addEventListener('click', () => {
                if (airportSelectors.length < 6) {
                    initializeNewAirportSelector(airportSelectors.length + 1);
                    updateMapAndSelections();
                }
            });

            airport1Select.addEventListener('change', updateMapAndSelections);
            airport2Select.addEventListener('change', updateMapAndSelections);
            searchAirport1Input.addEventListener('input', () => filterAirportOptions(airport1Select, searchAirport1Input));
            searchAirport2Input.addEventListener('input', () => filterAirportOptions(airport2Select, searchAirport2Input));

            buildRouteBtn.addEventListener('click', buildRoute);

            await loadInitialData();
        });
    </script>
</body>
</html>
